<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ…¢é‚® Slow Talk</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { background: #fdfcf8; font-family: sans-serif; padding: 20px; color: #333; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); max-width: 450px; margin: 0 auto; }
        input, textarea { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        button { width: 100%; padding: 12px; background: #222; color: #fff; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .letter { border-left: 4px solid #d4a373; padding: 10px; background: #fafafa; margin-bottom: 10px; cursor: pointer; }
        .time-info { font-size: 11px; color: #888; }
        #detail-page { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 100; display: none; padding: 20px; box-sizing: border-box; }
        .hidden { display: none; }
    </style>
</head>
<body>

<div class="card">
    <div id="auth-ui">
        <h2>ğŸ“« æ…¢é‚®ç™»å½•</h2>
        <input type="email" id="email" placeholder="é‚®ç®±">
        <input type="password" id="password" placeholder="å¯†ç ">
        <button onclick="doAuth()">è¿›å…¥</button>
    </div>

    <div id="app-ui" class="hidden">
        <p id="my-zip" style="font-weight:bold; text-align:center;"></p >
        <hr>
        <h4>âœ‰ï¸ å¯„ä¿¡</h4>
        <input type="text" id="t-zip" placeholder="æ”¶ä»¶é‚®ç¼–">
        <label style="font-size:12px; color:red">è§£é”æ—¶é—´ (ä¸å¯é€‰è¿‡å»):</label>
        <input type="datetime-local" id="t-time">
        <textarea id="t-body" placeholder="å†…å®¹..." rows="3"></textarea>
        <button onclick="send()">å‘é€</button>
        
        <h4 style="margin-top:20px">ğŸ“¬ æ”¶ä»¶ç®±</h4>
        <div id="list"></div>
    </div>
</div>

<div id="detail-page">
    <button onclick="document.getElementById('detail-page').style.display='none'">å…³é—­</button>
    <div id="d-meta" style="margin: 20px 0; color: #666; font-size: 13px;"></div>
    <div id="d-body" style="font-size: 16px; line-height: 1.6; white-space: pre-wrap;"></div>
    <hr>
    <textarea id="r-body" placeholder="å›ä¿¡å†…å®¹..." rows="3"></textarea>
    <button onclick="reply()">å›å¤å¯¹æ–¹</button>
</div>

<script>
    // --- è¯·åœ¨æ­¤å¤„å¡«å…¥ä½ çš„çœŸå®ä¿¡æ¯ ---
    const S_URL = 'https://ojwcwpfcewttukmuvuuk.supabase.co'; 
    const S_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9qd2N3cGZjZXd0dHVrbXV2dXVrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzNjAzMTEsImV4cCI6MjA4NTkzNjMxMX0.ObGKPq5F2hivJZuUWnW0269PJ1tkMNAwdCA4t5flCMI';
    // ----------------------------

    const _db = supabase.createClient(S_URL, S_KEY);
    let userZip = '', userId = '', targetReplyZip = '';

    // é™åˆ¶æ—¶é—´ï¼šç¦æ­¢é€‰æ‹©è¿‡å»
    function syncTimeLimit() {
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        const minStr = now.toISOString().slice(0, 16);
        document.getElementById('t-time').min = minStr;
        document.getElementById('t-time').value = minStr; // é»˜è®¤ç»™ä¸ªç°åœ¨çš„æ—¶é—´
    }

    async function doAuth() {
        const e = document.getElementById('email').value, p = document.getElementById('password').value;
        const { data, error } = await _db.auth.signInWithPassword({ email: e, password: p });
        if (error) {
            await _db.auth.signUp({ email: e, password: p });
            alert("è¯·æŸ¥æ”¶é‚®ä»¶æˆ–å†æ¬¡ç‚¹å‡»ç™»å½•");
        } else {
            initApp(data.user);
        }
    }

    async function initApp(user) {
        userId = user.id;
        const { data } = await _db.from('profiles').select('zip_code').eq('id', userId).single();
        if (data) {
            userZip = data.zip_code;
            document.getElementById('auth-ui').classList.add('hidden');
            document.getElementById('app-ui').classList.remove('hidden');
            document.getElementById('my-zip').innerText = "æˆ‘çš„é‚®ç¼–: " + userZip;
            syncTimeLimit();
            load();
        } else {
            const z = prompt("è®¾ç½®ä½ çš„é‚®ç¼–:");
            if (z) await _db.from('profiles').insert({id: userId, zip_code: z});
            location.reload();
        }
    }

    async function send(isReply = false) {
        const zip = isReply ? targetReplyZip : document.getElementById('t-zip').value;
        const body = isReply ? document.getElementById('r-body').value : document.getElementById('t-body').value;
        const time = isReply ? new Date().toISOString() : document.getElementById('t-time').value;

        if(!zip || !body) return alert("å†™å…¨äº†å—ï¼Ÿ");

        const { error } = await _db.from('letters').insert({
            sender_id: userId,
            sender_zip: userZip,
            target_zip: zip,
            content: body,
            unlock_at: time
        });

        if (error) alert("å‘é€å¤±è´¥:" + error.message);
        else { alert("å·²é€å¾€æœªæ¥"); location.reload(); }
    }

    async function load() {
        const { data } = await _db.from('letters').select('*').eq('target_zip', userZip).order('created_at', {ascending: false});
        const list = document.getElementById('list');
        list.innerHTML = data && data.length ? data.map(l => `
            <div class="letter" onclick="openL('${l.sender_zip}','${l.content}','${l.created_at}','${l.unlock_at}')">
                <div class="time-info">å¯„ï¼š${new Date(l.created_at).toLocaleString()}</div>
                <div class="time-info" style="color:green">åˆ°ï¼š${new Date(l.unlock_at).toLocaleString()}</div>
                <div style="margin-top:5px">${l.content.substring(0, 20)}...</div>
            </div>
        `).join('') : "ç©ºç©ºå¦‚ä¹Ÿ";
    }

    function openL(zip, body, c, u) {
        targetReplyZip = zip;
        document.getElementById('d-meta').innerHTML = `æ¥è‡ªï¼š${zip}<br>å¯„å‡ºæ—¶é—´ï¼š${new Date(c).toLocaleString()}<br>åˆ°è¾¾æ—¶é—´ï¼š${new Date(u).toLocaleString()}`;
        document.getElementById('d-body').innerText = body;
        document.getElementById('detail-page').style.display = 'block';
    }

    function reply() { send(true); }
</script>
</body>
</html>
