<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ…¢é‚® Slow Talk</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { background: #fdfcf8; font-family: sans-serif; padding: 20px; color: #333; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); max-width: 450px; margin: 0 auto; }
        input, textarea { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        button { width: 100%; padding: 12px; background: #222; color: #fff; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .hidden { display: none !important; }
        .letter { border-left: 4px solid #d4a373; padding: 10px; background: #fafafa; margin-bottom: 10px; }
        #detail-page { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 100; display: none; padding: 20px; box-sizing: border-box; }
    </style>
</head>
<body>

<div class="card">
    <div id="auth-ui">
        <h2>ğŸ“« æ…¢é‚®ç™»å½•</h2>
        <input type="email" id="email" placeholder="é‚®ç®±">
        <input type="password" id="password" placeholder="å¯†ç ">
        <button id="login-btn" onclick="doAuth()">è¿›å…¥é‚®å±€</button>
        <p id="auth-msg" style="font-size:12px; color:red;"></p >
    </div>

    <div id="app-ui" class="hidden">
        <p id="my-zip" style="font-weight:bold; text-align:center;"></p >
        <hr>
        <h4>âœ‰ï¸ å¯„å‡ºä¸€å°ä¿¡</h4>
        <input type="text" id="t-zip" placeholder="æ”¶ä»¶é‚®ç¼–">
        <label style="font-size:12px;">è§£é”æ—¶é—´ï¼š</label>
        <input type="datetime-local" id="t-time">
        <textarea id="t-body" placeholder="å†…å®¹..." rows="3"></textarea>
        <button onclick="send()">æŠ•å…¥é‚®ç­’</button>
        
        <h4 style="margin-top:20px">ğŸ“¬ æ”¶ä»¶ç®±</h4>
        <div id="list">åŠ è½½ä¸­...</div>
    </div>
</div>

<div id="detail-page">
    <button onclick="location.reload()">å…³é—­å¹¶è¿”å›</button>
    <div id="d-meta" style="margin: 20px 0; color: #666;"></div>
    <div id="d-body" style="font-size: 16px; white-space: pre-wrap;"></div>
</div>

<script>
    // é…ç½®ä¿¡æ¯
    const S_URL = 'https://ojwcwpfcewttukmuvuuk.supabase.co';
    const S_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9qd2N3cGZjZXd0dHVrbXV2dXVrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzNjAzMTEsImV4cCI6MjA4NTkzNjMxMX0.ObGKPq5F2hivJZuUWnW0269PJ1tkMNAwdCA4t5flCMI';
    
    // åˆå§‹åŒ–
    const _db = supabase.createClient(S_URL, S_KEY);
    let userId = '', userZip = '';

    // ç™»å½•/æ³¨å†Œé€»è¾‘
    async function doAuth() {
        const btn = document.getElementById('login-btn');
        btn.innerText = "å¤„ç†ä¸­...";
        const e = document.getElementById('email').value;
        const p = document.getElementById('password').value;

        try {
            const { data, error } = await _db.auth.signInWithPassword({ email: e, password: p });
            if (error) {
                // ç™»å½•å¤±è´¥å°è¯•æ³¨å†Œ
                const { error: regErr } = await _db.auth.signUp({ email: e, password: p });
                if (regErr) alert("é”™è¯¯: " + regErr.message);
                else alert("æ–°ç”¨æˆ·æ³¨å†ŒæˆåŠŸï¼è¯·å»é‚®ç®±ç¡®è®¤ï¼ˆæˆ–ç›´æ¥å†æ¬¡ç‚¹å‡»è¿›å…¥ï¼‰");
            } else {
                initApp(data.user);
            }
        } catch (err) {
            alert("ç³»ç»Ÿå´©æºƒ: " + err.message);
        } finally {
            btn.innerText = "è¿›å…¥é‚®å±€";
        }
    }

    async function initApp(user) {
        userId = user.id;
        const { data } = await _db.from('profiles').select('zip_code').eq('id', userId).single();
        
        if (data) {
            userZip = data.zip_code;
            document.getElementById('auth-ui').className = 'hidden';
            document.getElementById('app-ui').className = '';
            document.getElementById('my-zip').innerText = "æˆ‘çš„é‚®ç¼–: " + userZip;
            loadLetters();
        } else {
            const z = prompt("é¦–æ¬¡è¿›å…¥ï¼Œè¯·è®¾ç½®ä½ çš„é‚®ç¼–:");
            if (z) {
                await _db.from('profiles').insert({ id: userId, zip_code: z });
                location.reload();
            }
        }
    }

    async function send() {
        const zip = document.getElementById('t-zip').value;
        const body = document.getElementById('t-body').value;
        const time = document.getElementById('t-time').value;

        if (!zip || !body || !time) return alert("è¯·å¡«å…¨é‚®ç¼–ã€æ—¶é—´å†…å®¹");

        const { error } = await _db.from('letters').insert({
            sender_id: userId, sender_zip: userZip, target_zip: zip, content: body, unlock_at: time
        });

        if (error) alert("å¯„ä¿¡å¤±è´¥: " + error.message);
        else { alert("æŠ•é€’æˆåŠŸï¼"); location.reload(); }
    }

    async function loadLetters() {
        const { data } = await _db.from('letters').select('*').eq('target_zip', userZip).order('created_at', {ascending: false});
        const listDiv = document.getElementById('list');
        const now = new Date();

        if (!data || data.length === 0) {
            listDiv.innerText = "ä¿¡ç®±ç©ºç©ºçš„";
            return;
        }

        listDiv.innerHTML = data.map(l => {
            const isReady = now >= new Date(l.unlock_at);
            return `
                <div class="letter" onclick="view('${encodeURIComponent(l.content)}','${l.unlock_at}',${isReady})">
                    <div style="font-size:10px; color:#999">æ¥è‡ªé‚®ç¼–: ${l.sender_zip}</div>
                    <div>${isReady ? 'ğŸ“¬ ç‚¹å‡»é˜…è¯»' : 'â³ å¯†å°ä¸­ï¼ˆåˆ°è¾¾ï¼š' + new Date(l.unlock_at).toLocaleString() + 'ï¼‰'}</div>
                </div>
            `;
        }).join('');
    }

    function view(content, time, ready) {
        if (!ready) return alert("æ—¶é—´è¿˜æ²¡åˆ°ï¼Œä¿¡ä»¶è¿˜ä¸èƒ½æ‹†å¼€å“¦ï¼");
        document.getElementById('d-body').innerText = decodeURIComponent(content);
        document.getElementById('d-meta').innerText = "è¿™å°ä¿¡æ˜¯åœ¨ " + new Date(time).toLocaleString() + " å‡†æ—¶é€è¾¾çš„ã€‚";
        document.getElementById('detail-page').style.display = 'block';
    }
</script>
</body>
</html>
