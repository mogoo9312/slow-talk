<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>æ…¢é‚® Slow Talk</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --paper: #fdfcf8; --ink: #2c3e50; --accent: #d4a373; }
        body { background: var(--paper); color: var(--ink); font-family: "PingFang SC", "Microsoft YaHei", sans-serif; margin: 0; padding: 20px; }
        .container { max-width: 500px; margin: 0 auto; }
        input, textarea { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        button { width: 100%; padding: 15px; background: var(--ink); color: white; border: none; border-radius: 8px; font-weight: bold; margin-top: 10px; cursor: pointer; }
        
        /* ä¿¡ä»¶åˆ—è¡¨å¡ç‰‡ */
        .letter-item { background: white; padding: 15px; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); cursor: pointer; border-left: 4px solid var(--accent); }
        .time-label { font-size: 11px; color: #999; display: block; margin-bottom: 4px; }
        .preview { font-size: 14px; color: #444; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; }

        /* å…¨å±è¯¦æƒ…è½åœ°é¡µ */
        #detail-page { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--paper); z-index: 1000; display: none; padding: 30px; box-sizing: border-box; overflow-y: auto; }
        .back-btn { background: none; color: var(--accent); border: 1px solid var(--accent); width: auto; padding: 5px 15px; margin-bottom: 20px; }
        .detail-meta { font-size: 13px; color: #888; border-bottom: 1px dashed #ddd; padding-bottom: 15px; margin-bottom: 20px; line-height: 1.6; }
        .detail-content { font-size: 17px; line-height: 1.8; white-space: pre-wrap; margin-bottom: 40px; }
        
        .hidden { display: none; }
        #my-zip-display { text-align: center; font-weight: bold; background: #eee; padding: 10px; border-radius: 8px; margin-bottom: 20px; }
    </style>
</head>
<body>

<div class="container">
    <div id="auth-ui">
        <h2>ğŸ“« æ…¢é‚® | ç™»å½•</h2>
        <input type="email" id="email" placeholder="é‚®ç®±åœ°å€">
        <input type="password" id="password" placeholder="å¯†ç ">
        <button onclick="auth()">è¿›å…¥é‚®å±€</button>
    </div>

    <div id="app-ui" class="hidden">
        <div id="my-zip-display">æ­£åœ¨åŠ è½½é‚®ç¼–...</div>
        
        <div style="background: #fff; padding: 15px; border-radius: 12px; margin-bottom: 30px;">
            <h3 style="margin-top:0">âœ‰ï¸ å¯„å‡ºä¸€å°ä¿¡</h3>
            <input type="text" id="target-zip" placeholder="æ”¶ä»¶äººé‚®ç¼–">
            <label style="font-size:12px; color:red;">è§£é”æ—¶é—´ (åªèƒ½é€‰æœªæ¥):</label>
            <input type="datetime-local" id="unlock-time">
            <textarea id="mail-body" rows="4" placeholder="å†™ä¸‹ä½ æƒ³è¯´çš„è¯..."></textarea>
            <button onclick="sendMail()" id="send-btn">æŠ•å…¥é‚®ç­’</button>
        </div>

        <h3>ğŸ“¬ æ”¶ä»¶ç®±</h3>
        <div id="list-container">æ£€æŸ¥ä¿¡ç®±ä¸­...</div>
    </div>
</div>

<div id="detail-page">
    <button class="back-btn" onclick="closeDetail()">â† è¿”å›</button>
    <div id="detail-header" class="detail-meta"></div>
    <div id="detail-body" class="detail-content"></div>
    
    <div style="background:#fff; padding:15px; border-radius:12px; border:1px solid #eee;">
        <h4>å¿«é€Ÿå›ä¿¡</h4>
        <textarea id="reply-text" rows="3" placeholder="ç»™å¯¹æ–¹å›ä¸€å°ä¿¡..."></textarea>
        <button onclick="replyMail()" style="background:var(--accent)">ç«‹å³å¯„å›</button>
    </div>
</div>

<script>
    // ã€è¿™é‡Œçš„ URL å’Œ KEY å¿…é¡»å¡«ï¼ã€‘
    const S_URL = https://ojwcwpfcewttukmuvuuk.supabase.co';
    const S_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9qd2N3cGZjZXd0dHVrbXV2dXVrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzNjAzMTEsImV4cCI6MjA4NTkzNjMxMX0.ObGKPq5F2hivJZuUWnW0269PJ1tkMNAwdCA4t5flCMI';
    const _db = supabase.createClient(S_URL, S_KEY);

    let me = null;
    let myZip = '';
    let currentOpponentZip = ''; // ç”¨äºè®°å½•å½“å‰æŸ¥çœ‹ä¿¡ä»¶çš„å¯¹æ–¹é‚®ç¼–

    // 1. åˆå§‹åŒ–æ—¶é—´é€‰æ‹©å™¨ï¼šç¦æ­¢é€‰æ‹©è¿‡å»
    function setMinTime() {
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        document.getElementById('unlock-time').min = now.toISOString().slice(0, 16);
    }

    async function auth() {
        const e = document.getElementById('email').value, p = document.getElementById('password').value;
        const { data, error } = await _db.auth.signInWithPassword({ email: e, password: p });
        if (error) {
            const { error: regErr } = await _db.auth.signUp({ email: e, password: p });
            if (regErr) alert("ç™»å½•å¤±è´¥: " + regErr.message); else alert("æ³¨å†ŒæˆåŠŸï¼Œè¯·å†æ¬¡ç‚¹å‡»ç™»å½•");
        } else {
            loadProfile(data.user);
        }
    }

    async function loadProfile(user) {
        me = user;
        const { data } = await _db.from('profiles').select('zip_code').eq('id', user.id).single();
        if (data) {
            myZip = data.zip_code;
            document.getElementById('auth-ui').classList.add('hidden');
            document.getElementById('app-ui').classList.remove('hidden');
            document.getElementById('my-zip-display').innerText = "æˆ‘çš„é‚®ç¼–: " + myZip;
            setMinTime();
            loadInbox();
        } else {
            const z = prompt("ä¸ºè‡ªå·±è®¾ç½®ä¸€ä¸ªé‚®ç¼–ï¼ˆåˆ«äººå¯„ä¿¡ç»™ä½ ç”¨ï¼‰ï¼š");
            if (z) { await _db.from('profiles').insert([{id: user.id, zip_code: z}]); location.reload(); }
        }
    }

    // 2. å‘ä¿¡åŠŸèƒ½ï¼šå¸¦ä¸Šå‘ä»¶äººé‚®ç¼–
    async function sendMail(isReply = false) {
        const target = isReply ? currentOpponentZip : document.getElementById('target-zip').value;
        const body = isReply ? document.getElementById('reply-text').value : document.getElementById('mail-body').value;
        const time = isReply ? new Date().toISOString() : document.getElementById('unlock-time').value;

        if (!target || !body || (!isReply && !time)) return alert("è¯·å¡«å†™å®Œæ•´ä¿¡æ¯");

        const { error } = await _db.from('letters').insert([{
            sender_id: me.id,
            sender_zip: myZip,
            target_zip: target,
            content: body,
            unlock_at: time
        }]);

        if (error) alert(error.message);
        else { alert("å¯„é€æˆåŠŸï¼"); location.reload(); }
    }

    // 3. æ”¶ä»¶ç®±åˆ—è¡¨ï¼šæ˜¾ç¤ºå‘é€å’Œåˆ°è¾¾æ—¶é—´
    async function loadInbox() {
        const { data } = await _db.from('letters').select('*').eq('target_zip', myZip).order('created_at', {ascending: false});
        const container = document.getElementById('list-container');
        if (!data || data.length === 0) { container.innerHTML = "ä¿¡ç®±æš‚æ—¶æ˜¯ç©ºçš„"; return; }

        container.innerHTML = data.map(l => `
            <div class="letter-item" onclick="showDetail('${l.sender_zip}', '${l.content}', '${l.created_at}', '${l.unlock_at}')">
                <span class="time-label">ğŸ“© å¯„å‡ºï¼š${new Date(l.created_at).toLocaleString()}</span>
                <span class="time-label">ğŸ”” åˆ°è¾¾ï¼š${new Date(l.unlock_at).toLocaleString()}</span>
                <div class="preview">${l.content}</div>
            </div>
        `).join('');
    }

    // 4. è½åœ°è¯¦æƒ…é¡µï¼šç‚¹å‡»è¿›å…¥è¯¦æƒ…ï¼Œæ”¯æŒå›ä¿¡
    function showDetail(fromZip, content, sentAt, unlockAt) {
        currentOpponentZip = fromZip;
        document.getElementById('detail-header').innerHTML = `
            <b>æ¥è‡ªé‚®ç¼–ï¼š</b>${fromZip}<br>
            <b>å¯„å‡ºæ—¶é—´ï¼š</b>${new Date(sentAt).toLocaleString()}<br>
            <b>åˆ°è¾¾æ—¶é—´ï¼š</b>${new Date(unlockAt).toLocaleString()}
        `;
        document.getElementById('detail-body').innerText = content;
        document.getElementById('detail-page').style.display = 'block';
    }

    function closeDetail() { document.getElementById('detail-page').style.display = 'none'; }
    
    function replyMail() { sendMail(true); }
</script>

</body>
</html>
