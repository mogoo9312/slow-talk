<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ…¢é‚® Slow Talk - å¯†å‹ç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --accent: #d4a373; --bg: #fdfcf8; --gray: #999; --me-bg: #e2e2e2; }
        body { background: var(--bg); font-family: sans-serif; padding: 20px; color: #333; margin: 0; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); max-width: 500px; margin: 10px auto; position: relative; }
        input, textarea { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        
        button { width: 100%; padding: 12px; background: #222; color: #fff; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .logout-link { position: absolute; top: 20px; right: 20px; font-size: 12px; color: var(--gray); cursor: pointer; }
        
        /* è”ç³»äººåˆ—è¡¨æ ·å¼ */
        .contact-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; background: white; border: 1px solid #eee; margin-bottom: 10px; border-radius: 10px; cursor: pointer; transition: 0.2s; }
        .contact-item:hover { border-color: var(--accent); }
        .contact-info b { font-size: 16px; }
        
        /* è¯¦æƒ…/æ—¶é—´çº¿é¡µé¢ */
        #chat-page { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 1000; display: none; flex-direction: column; }
        #chat-header { padding: 15px; background: white; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 10px; }
        #chat-timeline { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        
        /* æ°”æ³¡æ ·å¼ */
        .msg { max-width: 80%; padding: 12px; border-radius: 12px; position: relative; font-size: 15px; line-height: 1.5; }
        .msg.from { align-self: flex-start; background: white; border: 1px solid #eee; }
        .msg.to { align-self: flex-end; background: var(--accent); color: white; }
        .msg.locked { opacity: 0.6; filter: grayscale(1); }
        .msg-time { font-size: 10px; margin-top: 5px; opacity: 0.7; }

        .hidden { display: none !important; }
        .remark-btn { font-size: 12px; padding: 4px 8px; background: #eee; color: #666; width: auto; margin: 0; }
    </style>
</head>
<body>

<div class="card">
    <div id="auth-ui">
        <h2>ğŸ“« æ…¢é‚®ç™»å½•</h2>
        <input type="email" id="email" placeholder="é‚®ç®±">
        <input type="password" id="password" placeholder="å¯†ç ">
        <button onclick="doAuth()">è¿›å…¥é‚®å±€</button>
    </div>

    <div id="app-ui" class="hidden">
        <span class="logout-link" onclick="doLogout()">é€€å‡º</span>
        <p id="my-zip" style="font-weight:bold; text-align:center; color:var(--accent);"></p >
        
        <div style="background: #f9f9f9; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
            <h4 style="margin:0 0 10px 0">âœ‰ï¸ å‘èµ·æ–°æŠ•é€’</h4>
            <input type="text" id="t-zip" placeholder="æ”¶ä»¶é‚®ç¼–">
            <button onclick="openChat(document.getElementById('t-zip').value)">å»å†™ä¿¡</button>
        </div>

        <h4>ğŸ‘¥ è”ç³»äºº (æ—¶é—´çº¿å½’ç±»)</h4>
        <div id="contact-list">åŠ è½½ä¸­...</div>
    </div>
</div>

<div id="chat-page">
    <div id="chat-header">
        <button onclick="closeChat()" style="width:auto; background:none; color:#222; font-size:20px;">â†</button>
        <div style="flex:1">
            <span id="chat-title" style="font-weight:bold;"></span>
            <button class="remark-btn" onclick="editRemark()">ä¿®æ”¹å¤‡æ³¨</button>
        </div>
    </div>
    
    <div id="chat-timeline"></div>

    <div style="padding: 15px; background: white; border-top: 1px solid #eee;">
        <label style="font-size:12px; color: var(--gray);">è®¾å®šè§£é”æ—¶é—´ï¼š</label>
        <input type="datetime-local" id="t-time">
        <textarea id="t-body" placeholder="å†™ä¸‹ä½ çš„è¯..." rows="3"></textarea>
        <button onclick="sendLetter()" id="send-btn">æŠ•è¿›æ—¶å…‰éš§é“</button>
    </div>
</div>

<script>
    const S_URL = 'https://ojwcwpfcewttukmuvuuk.supabase.co'; 
    const S_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9qd2N3cGZjZXd0dHVrbXV2dXVrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzNjAzMTEsImV4cCI6MjA4NTkzNjMxMX0.ObGKPq5F2hivJZuUWnW0269PJ1tkMNAwdCA4t5flCMI';
    const _db = supabase.createClient(S_URL, S_KEY);
    
    let userZip = '', userId = '', activeChatZip = '';

    window.onload = async () => {
        const { data: { session } } = await _db.auth.getSession();
        if (session) initApp(session.user);
    };

    async function doAuth() {
        const e = document.getElementById('email').value, p = document.getElementById('password').value;
        const { data, error } = await _db.auth.signInWithPassword({ email: e, password: p });
        if (error) {
            const { error: regErr } = await _db.auth.signUp({ email: e, password: p });
            if (regErr) alert(regErr.message); else alert("æ³¨å†ŒæˆåŠŸï¼Œè¯·é‡æ–°ç‚¹å‡»ç™»å½•");
        } else { initApp(data.user); }
    }

    async function doLogout() { await _db.auth.signOut(); location.reload(); }

    async function initApp(user) {
        userId = user.id;
        const { data } = await _db.from('profiles').select('zip_code').eq('id', userId).single();
        if (data) {
            userZip = data.zip_code;
            document.getElementById('auth-ui').classList.add('hidden');
            document.getElementById('app-ui').classList.remove('hidden');
            document.getElementById('my-zip').innerText = "ğŸ“ æˆ‘çš„é‚®ç¼–: " + userZip;
            loadContacts();
        } else {
            const z = prompt("é¦–æ¬¡è¿›å…¥ï¼Œè¯·è®¾ç½®æ‚¨çš„é‚®ç¼–ï¼š");
            if (z) { await _db.from('profiles').insert({id: userId, zip_code: z}); location.reload(); }
        }
    }

    // è·å–å¤‡æ³¨å
    function getDisplayName(zip) {
        const remarks = JSON.parse(localStorage.getItem('remarks') || '{}');
        return remarks[zip] ? `${remarks[zip]} (${zip})` : `(${zip})`;
    }

    function editRemark() {
        const newR = prompt("è®¾ç½®å¤‡æ³¨åç§°ï¼š");
        if (newR !== null) {
            const remarks = JSON.parse(localStorage.getItem('remarks') || '{}');
            remarks[activeChatZip] = newR;
            localStorage.setItem('remarks', JSON.stringify(remarks));
            document.getElementById('chat-title').innerText = getDisplayName(activeChatZip);
            loadContacts();
        }
    }

    async function loadContacts() {
        // è·å–æ‰€æœ‰ä¸æˆ‘ç›¸å…³çš„ä¿¡ä»¶ï¼ˆæ”¶æˆ–å‘ï¼‰
        const { data } = await _db.from('letters').select('*')
            .or(`target_zip.eq.${userZip},sender_zip.eq.${userZip}`)
            .order('created_at', {ascending: false});

        const groups = {};
        data?.forEach(l => {
            const otherZip = (l.sender_zip === userZip) ? l.target_zip : l.sender_zip;
            if (!groups[otherZip]) groups[otherZip] = l;
        });

        const list = document.getElementById('contact-list');
        const zips = Object.keys(groups);
        if (zips.length === 0) { list.innerHTML = "<p style='color:#999'>æš‚æ— è”ç³»äºº</p >"; return; }

        list.innerHTML = zips.map(zip => `
            <div class="contact-item" onclick="openChat('${zip}')">
                <div class="contact-info">
                    <b>${getDisplayName(zip)}</b>
                    <div style="font-size:12px; color:#888;">æœ€åå¾€æ¥: ${new Date(groups[zip].created_at).toLocaleDateString()}</div>
                </div>
                <span>â†’</span>
            </div>
        `).join('');
    }

    async function openChat(zip) {
        if (!zip) return alert("è¯·è¾“å…¥é‚®ç¼–");
        activeChatZip = zip;
        document.getElementById('chat-page').style.display = 'flex';
        document.getElementById('chat-title').innerText = getDisplayName(zip);
        
        // é‡ç½®å†™ä¿¡åŒºåŸŸæ—¶é—´
        const now = new Date();
        const tzOffset = now.getTimezoneOffset() * 60000; 
        document.getElementById('t-time').value = new Date(now - tzOffset).toISOString().slice(0, 16);
        
        loadTimeline();
    }

    async function loadTimeline() {
        const { data } = await _db.from('letters').select('*')
            .or(`and(sender_zip.eq.${userZip},target_zip.eq.${activeChatZip}),and(sender_zip.eq.${activeChatZip},target_zip.eq.${userZip})`)
            .order('unlock_at', {ascending: true});

        const timeline = document.getElementById('chat-timeline');
        const now = new Date();

        timeline.innerHTML = data.map(l => {
            const isFromMe = l.sender_zip === userZip;
            const unlockDate = new Date(l.unlock_at);
            const isLocked = now < unlockDate;
            
            let content = isFromMe ? l.content : (isLocked ? "ğŸ”’ ä¿¡ä»¶è¿˜åœ¨è¿™æ—¶å…‰éš§é“ä¸­ï¼Œå°šæœªæŠµè¾¾..." : l.content);
            
            return `
                <div class="msg ${isFromMe ? 'to' : 'from'} ${isLocked && !isFromMe ? 'locked' : ''}">
                    <div style="white-space: pre-wrap;">${content}</div>
                    <div class="msg-time">${isLocked ? 'â³ è§£é”äº: ' : ''}${unlockDate.toLocaleString()}</div>
                </div>
            `;
        }).join('');
        timeline.scrollTop = timeline.scrollHeight;
    }

    async function sendLetter() {
        const body = document.getElementById('t-body').value, localTime = document.getElementById('t-time').value;
        if(!body || !localTime) return alert("å†…å®¹å’Œæ—¶é—´ä¸èƒ½ä¸ºç©º");

        const btn = document.getElementById('send-btn');
        btn.disabled = true;
        const { error } = await _db.from('letters').insert({
            sender_id: userId, sender_zip: userZip, target_zip: activeChatZip, content: body, unlock_at: new Date(localTime).toISOString()
        });
        
        btn.disabled = false;
        if (error) alert(error.message);
        else { document.getElementById('t-body').value = ''; loadTimeline(); }
    }

    function closeChat() { document.getElementById('chat-page').style.display = 'none'; loadContacts(); }
</script>
</body>
</html>
