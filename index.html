<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>æ…¢é‚® Slow Talk</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #f4f4f4; }
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); max-width: 500px; margin: auto; }
        input { display: block; width: 100%; margin: 10px 0; padding: 10px; box-sizing: border-box; }
        button { width: 100%; padding: 10px; cursor: pointer; background: #333; color: white; border: none; border-radius: 4px; }
        .hidden { display: none; }
    </style>
</head>
<body>

<div class="card">
    <div id="auth-ui">
        <h2>ğŸ“¬ ç™»å½•/æ³¨å†Œ</h2>
        <input type="email" id="email" placeholder="é‚®ç®±">
        <input type="password" id="password" placeholder="å¯†ç ">
        <button onclick="doSignUp()" style="background:#eee; color:#333; margin-bottom:10px;">æ³¨å†Œæ–°è´¦å·</button>
        <button onclick="doLogin()">ç«‹å³ç™»å½•</button>
    </div>

    <div id="user-ui" class="hidden">
        <h2 id="welcome-msg">âœ¨ æ¬¢è¿</h2>
        <div id="zip-area" style="background:#fffbe6; padding:15px; border:1px solid #ffe58f; margin-bottom:10px;">
            </div>
        <button onclick="doLogout()" style="background:#ff4757;">é€€å‡ºç™»å½•</button>
    </div>
</div>

<script>
    // --- 1. é…ç½® (å…¨å±€å”¯ä¸€) ---
    const URL = 'https://ojwcwpfcewttukmuvuuk.supabase.co';
    const KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9qd2N3cGZjZXd0dHVrbXV2dXVrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzNjAzMTEsImV4cCI6MjA4NTkzNjMxMX0.ObGKPq5F2hivJZuUWnW0269PJ1tkMNAwdCA4t5flCMI';
    
    // --- 2. åˆå§‹åŒ– (ç¡®ä¿æ•´ä¸ªæ–‡ä»¶åªæœ‰è¿™ä¸€å¤„) ---
    const supabase = window.supabase.createClient(URL, KEY);

    // --- 3. æ ¸å¿ƒåŠŸèƒ½ ---
    async function doSignUp() {
        const e = document.getElementById('email').value;
        const p = document.getElementById('password').value;
        const { error } = await supabase.auth.signUp({ email: e, password: p });
        if (error) alert(error.message); else alert("æ³¨å†ŒæˆåŠŸï¼Œè¯·å°è¯•ç™»å½•");
    }

    async function doLogin() {
        const e = document.getElementById('email').value;
        const p = document.getElementById('password').value;
        const { error } = await supabase.auth.signInWithPassword({ email: e, password: p });
        if (error) alert(error.message); else checkUser();
    }

    async function doLogout() {
        await supabase.auth.signOut();
        location.reload();
    }

    async function saveZip(uid) {
        const z = document.getElementById('zip-input').value;
        const { error } = await supabase.from('profiles').insert([{ id: uid, zip_code: z }]);
        if (error) alert("è¯¥é‚®ç¼–å·²è¢«å ç”¨æˆ–ä¿å­˜å¤±è´¥"); else checkUser();
    }

    async function checkUser() {
        const { data: { user } } = await supabase.auth.getUser();
        const authUI = document.getElementById('auth-ui');
        const userUI = document.getElementById('user-ui');
        const zipArea = document.getElementById('zip-area');

        if (user) {
            authUI.classList.add('hidden');
            userUI.classList.remove('hidden');
            document.getElementById('welcome-msg').innerText = "è´¦å·ï¼š" + user.email;

            // æŸ¥é‚®ç¼–
            const { data: profile } = await supabase.from('profiles').select('zip_code').eq('id', user.id).single();
            if (profile) {
                zipArea.innerHTML = "æˆ‘çš„ä¸“å±é‚®ç¼–ï¼š<strong>" + profile.zip_code + "</strong>";
            } else {
                zipArea.innerHTML = `
                    <p>ç»‘å®šä¸€ä¸ªæ°¸ä¹…é‚®ç¼–ï¼š</p>
                    <input type="text" id="zip-input" placeholder="å¦‚: 666888">
                    <button onclick="saveZip('${user.id}')">ç¡®è®¤ç»‘å®š</button>
                `;
            }
        }
    }

    // è‡ªåŠ¨è¿è¡Œ
    checkUser();
</script>
</body>
</html>
